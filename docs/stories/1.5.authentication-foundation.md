# Story 1.5: Authentication Foundation

## Status
Draft

## Story
**As a** user of the maintenance management system,
**I want** to have secure role-based authentication and authorization,
**so that** I can access appropriate system features based on my role as an admin, supervisor, or operator.

## Acceptance Criteria
1. Supabase Auth integration implemented with JWT token handling
2. User management system created with role-based access control (admin/supervisor/operator)
3. Row Level Security policies implemented in database for data access control
4. Authentication UI components built (login, register, profile, password reset)
5. Protected routes and permission middleware implemented
6. Session management with automatic token refresh and logout handling
7. User profile management with preferences and notification settings

## Tasks / Subtasks
- [ ] Implement Supabase Auth integration (AC: 1)
  - [ ] Configure Supabase Auth client with proper settings
  - [ ] Implement JWT token handling and storage
  - [ ] Create authentication service with login/logout functionality
  - [ ] Set up automatic token refresh mechanism
  - [ ] Implement session persistence and recovery
- [ ] Create user management system with roles (AC: 2)
  - [ ] Design user data model with role-based permissions
  - [ ] Implement user CRUD operations for admin users
  - [ ] Create role-based permission checking utilities
  - [ ] Set up user profile management interfaces
  - [ ] Implement user activation/deactivation functionality
- [ ] Implement Row Level Security (RLS) policies (AC: 3)
  - [ ] Create RLS policies for users table access
  - [ ] Implement work order access restrictions by role
  - [ ] Set up equipment view permissions
  - [ ] Create spare parts access controls
  - [ ] Test RLS policies thoroughly with different user roles
- [ ] Build authentication UI components (AC: 4)
  - [ ] Create responsive login form with validation
  - [ ] Build user registration form with role assignment
  - [ ] Implement password reset flow UI
  - [ ] Create user profile management interface
  - [ ] Build logout confirmation and session management UI
- [ ] Implement protected routes and permissions (AC: 5)
  - [ ] Create authentication middleware for API routes
  - [ ] Implement protected route components for frontend
  - [ ] Set up role-based access control for UI elements
  - [ ] Create permission checking hooks and utilities
  - [ ] Implement automatic redirect for unauthenticated users
- [ ] Set up session management (AC: 6)
  - [ ] Implement session timeout handling
  - [ ] Create automatic logout on token expiration
  - [ ] Set up session persistence across browser refreshes
  - [ ] Implement multi-device session management
  - [ ] Create session activity tracking
- [ ] Create user profile and preferences (AC: 7)
  - [ ] Build user profile editing interface
  - [ ] Implement notification preferences management
  - [ ] Create theme and language selection
  - [ ] Set up user activity tracking and last login
  - [ ] Implement user account deletion and data export

## Dev Notes

### Authentication Architecture
```typescript
// Authentication flow
1. User enters credentials → Supabase Auth
2. Supabase validates → Returns JWT + user data
3. Store JWT securely → Update user state
4. Include JWT in API requests → Backend validation
5. Backend verifies with Supabase → Apply RLS policies
6. Return appropriate data based on user role
```

### User Roles and Permissions
```typescript
// Role definitions
interface UserRole {
  admin: {
    permissions: ['user_management', 'system_config', 'all_data_access'];
    canAccess: ['admin_panel', 'user_management', 'system_settings'];
  };
  supervisor: {
    permissions: ['work_order_management', 'equipment_management', 'team_view'];
    canAccess: ['work_orders', 'equipment', 'reports', 'team_dashboard'];
  };
  operator: {
    permissions: ['assigned_work_orders', 'parts_usage', 'profile_management'];
    canAccess: ['my_orders', 'spare_parts', 'profile'];
  };
}
```

### Supabase Configuration
```typescript
// Supabase Auth settings
const supabase = createClient(url, anonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    flowType: 'pkce', // Recommended for web apps
  },
});
```

### Row Level Security Policies
```sql
-- RLS policies for work_orders table
CREATE POLICY "Operators can view assigned work orders" ON work_orders
  FOR SELECT USING (
    auth.uid()::text = assigned_operator_id::text
  );

CREATE POLICY "Supervisors can view all work orders" ON work_orders
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid()
      AND role = 'supervisor'
    )
  );

CREATE POLICY "Admins have full access" ON work_orders
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid()
      AND role = 'admin'
    )
  );
```

### Frontend Authentication Components
```typescript
// Component structure
src/components/auth/
├── LoginForm.tsx          # Login form with validation
├── RegisterForm.tsx       # User registration
├── PasswordReset.tsx      # Password reset flow
├── ProfileManager.tsx     # User profile editing
├── SessionManager.tsx     # Session state management
└── ProtectedRoute.tsx     # Route protection wrapper
```

### Authentication Service
```typescript
// Auth service methods
class AuthService {
  async login(email: string, password: string): Promise<User>;
  async logout(): Promise<void>;
  async register(userData: RegisterData): Promise<User>;
  async resetPassword(email: string): Promise<void>;
  async updateProfile(updates: ProfileUpdates): Promise<User>;
  async getCurrentUser(): Promise<User | null>;
  onAuthStateChange(callback: (user: User | null) => void): Unsubscribe;
}
```

### Backend Authentication Middleware
```typescript
// Express middleware
interface AuthenticatedRequest extends Request {
  user: {
    id: string;
    role: 'admin' | 'supervisor' | 'operator';
    email: string;
  };
}

const authenticateToken = async (req: AuthenticatedRequest, res: Response, next: NextFunction) => {
  // JWT validation logic
  // User role lookup
  // Attach user to request object
};
```

### Permission Checking System
```typescript
// Permission utilities
const hasPermission = (user: User, permission: string): boolean => {
  const rolePermissions = ROLE_PERMISSIONS[user.role];
  return rolePermissions.includes(permission);
};

const canAccessResource = (user: User, resource: string): boolean => {
  const roleResources = ROLE_RESOURCES[user.role];
  return roleResources.includes(resource);
};
```

### Session Management Strategy
```typescript
// Session handling
- Token storage: httpOnly cookies for security
- Session timeout: 24 hours with inactivity tracking
- Auto-refresh: Silent token refresh before expiration
- Multi-device: Support multiple concurrent sessions
- Security: Automatic logout on suspicious activity
```

### User Profile Data Model
```typescript
interface User {
  id: string;
  email: string;
  name: string;
  role: 'admin' | 'supervisor' | 'operator';
  isActive: boolean;
  lastLoginAt: string;
  createdAt: string;
  phoneNumber?: string;
  department?: string;
  preferences: {
    language: string;
    theme: 'light' | 'dark' | 'auto';
    notifications: {
      email: boolean;
      push: boolean;
      workOrderAssignment: boolean;
      lowStockAlert: boolean;
    };
  };
}
```

### Security Considerations
```typescript
// Security measures
- Password requirements: 8+ characters, complexity
- Rate limiting: 5 login attempts per 15 minutes
- Session security: Secure, httpOnly cookies
- CSRF protection: SameSite cookie attributes
- Input validation: All user inputs sanitized
- Audit logging: All authentication events logged
```

### Mobile Authentication Considerations
```typescript
// Mobile-specific features
- Touch-friendly login form with large touch targets
- Biometric authentication support (future enhancement)
- Offline authentication indication
- Quick logout for shared devices
- Responsive design for tablet login
```

### Testing Requirements
- **Unit Tests:** Authentication service methods
- **Integration Tests:** Login/logout flows
- **E2E Tests:** Complete authentication workflows
- **Security Tests:** Permission bypass attempts
- **Mobile Tests:** Touch interactions and responsive design

### Error Handling
```typescript
// Authentication error scenarios
- Invalid credentials handling
- Network connectivity issues
- Token expiration and refresh failures
- User account deactivated scenarios
- Permission denied error handling
- Session timeout user notification
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*