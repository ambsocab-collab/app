# Story 2.1: Equipment Hierarchy Management

## Status
Draft

## Story
**As a** system administrator,
**I want** to create and manage a flexible hierarchical equipment structure,
**so that** maintenance operations can be organized effectively across different levels of the facility from plant to individual components.

## Acceptance Criteria
1. Equipment data model supports 5-level hierarchy (Plant → Area → Functional Unit → Equipment → Components)
2. Equipment CRUD operations with proper validation and error handling
3. Tree navigation interface for viewing and managing equipment hierarchy
4. Equipment search and filtering capabilities by type, location, and status
5. Equipment detail view with maintenance history and associated spare parts
6. Bulk operations for equipment status updates and reorganization
7. Equipment relationship management with parent-child constraints

## Tasks / Subtasks
- [ ] Implement equipment data model with hierarchical relationships (AC: 1)
  - [ ] Create equipment TypeScript interfaces with hierarchy support
  - [ ] Implement database schema with parent_id and level fields
  - [ ] Add recursive query functions for hierarchy navigation
  - [ ] Create hierarchy validation rules and constraints
  - [ ] Implement equipment type enumeration and validation
- [ ] Build equipment CRUD API endpoints (AC: 2)
  - [ ] Create POST /equipment endpoint with hierarchy validation
  - [ ] Implement PUT /equipment/{id} with relationship updates
  - [ ] Build DELETE /equipment/{id} with cascade validation
  - [ ] Add GET /equipment/{id} with full hierarchy context
  - [ ] Implement bulk operations endpoint for multiple equipment
- [ ] Create tree navigation interface (AC: 3)
  - [ ] Build recursive tree component with expand/collapse
  - [ ] Implement drag-and-drop for hierarchy reorganization
  - [ ] Create breadcrumb navigation for hierarchy context
  - [ ] Add level indicators and visual hierarchy representation
  - [ ] Implement lazy loading for large equipment trees
- [ ] Implement search and filtering functionality (AC: 4)
  - [ ] Create search interface with multiple filter criteria
  - [ ] Implement equipment type filtering with dropdown
  - [ ] Build location-based search with hierarchy context
  - [ ] Add status filtering (active, inactive, maintenance, decommissioned)
  - [ ] Create advanced search with multiple criteria combinations
- [ ] Build equipment detail view (AC: 5)
  - [ ] Create comprehensive equipment information display
  - [ ] Implement maintenance history timeline view
  - [ ] Build associated spare parts display with stock levels
  - [ ] Add related work orders and completion status
  - [ ] Create equipment documents and attachments section
- [ ] Implement bulk operations management (AC: 6)
  - [ ] Create multi-select interface for equipment selection
  - [ ] Build bulk status update with confirmation workflow
  - [ ] Implement bulk reorganization with validation
  - [ ] Add bulk export to CSV/Excel functionality
  - [ ] Create bulk import with validation and error reporting
- [ ] Create equipment relationship management (AC: 7)
  - [ ] Build parent-child relationship management interface
  - [ ] Implement relationship validation and constraint checking
  - [ ] Create relationship visualization and impact analysis
  - [ ] Add equipment movement with dependency tracking
  - [ ] Implement relationship change audit trail

## Dev Notes

### Equipment Data Model
```typescript
interface Equipment {
  id: string;
  name: string;
  code: string;
  type: 'plant' | 'area' | 'functional_unit' | 'equipment' | 'component';
  parentId?: string;
  level: number; // 0=root plant level
  location: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  installationDate?: string;
  status: 'active' | 'inactive' | 'maintenance' | 'decommissioned';
  maintenanceNotes?: string;
  associatedSpareParts: string[]; // spare part IDs
  children?: Equipment[];
  parent?: Equipment;
}
```

### Database Schema Reference
```sql
-- From architecture.md database schema
CREATE TABLE equipment (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) NOT NULL,
    type VARCHAR(20) CHECK (type IN ('plant', 'area', 'functional_unit', 'equipment', 'component')) NOT NULL,
    parent_id UUID REFERENCES equipment(id),
    level INTEGER NOT NULL DEFAULT 0,
    location VARCHAR(200) NOT NULL,
    manufacturer VARCHAR(100),
    model VARCHAR(100),
    serial_number VARCHAR(100),
    installation_date DATE,
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'maintenance', 'decommissioned')) DEFAULT 'active',
    maintenance_notes TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API Endpoints (from architecture.md)
```typescript
// Equipment API endpoints
GET /equipment?parentId={id}&level={n}&type={type}
POST /equipment
PUT /equipment/{id}
POST /equipment/import
```

### Hierarchy Validation Rules
- Plant level (level 0) cannot have parent
- Maximum depth limited to 5 levels
- Parent-child relationships must match type hierarchy
- Circular references prevented
- Child equipment cannot be deleted if active work orders exist

### Search and Filtering Strategy
- **Type-based filtering:** Dropdown with equipment types
- **Location search:** Hierarchical location selection
- **Status filtering:** Multi-select status options
- **Text search:** Searches name, code, location, manufacturer
- **Advanced search:** Combines multiple criteria with AND/OR logic

### Performance Considerations
- Recursive queries optimized with Common Table Expressions (CTE)
- Tree structure caching for frequently accessed hierarchies
- Lazy loading for large equipment trees (>1000 items)
- Database indexes on parent_id, type, and status fields
- Pagination for search results and large lists

### Security and Permissions
- **Admin:** Full CRUD operations on all equipment
- **Supervisor:** View and edit assigned area equipment
- **Operator:** View-only access to equipment details
- Row Level Security policies implemented at database level

### Mobile Interface Considerations
- Touch-friendly tree navigation with large tap targets
- Swipe gestures for quick equipment actions
- Collapsible sections for mobile screen optimization
- Quick search interface optimized for mobile keyboards
- Equipment cards with essential information at a glance

### Error Handling Scenarios
- Duplicate equipment codes within same level
- Invalid parent-child type relationships
- Circular reference detection in hierarchy
- Equipment deletion with existing dependencies
- Bulk operation failures with detailed error reporting

### Testing Requirements
- Unit tests for hierarchy validation logic
- Integration tests for all CRUD operations
- E2E tests for tree navigation and search functionality
- Performance tests for large equipment datasets
- Mobile device testing for responsive interface

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*