# Story 1.3: Backend Infrastructure

## Status
Draft

## Story
**As a** developer,
**I want** to establish a complete backend infrastructure with Express.js, Supabase integration, database migrations, and API documentation,
**so that** the maintenance management system has a solid, scalable, and well-documented backend foundation.

## Acceptance Criteria
1. Express.js server configured with TypeScript, middleware, and proper error handling
2. Supabase CLI setup and project initialized with proper connection configuration
3. Database schema migration scripts created and executed successfully
4. Seed data planned and implemented for development and testing environments
5. API documentation set up with complete OpenAPI 3.0 specification
6. Development environment configured with hot reload and proper debugging
7. Security infrastructure established with authentication middleware and CORS configuration

## Tasks / Subtasks
- [ ] Set up Express.js server with TypeScript configuration (AC: 1)
  - [ ] Initialize Express server with TypeScript support
  - [ ] Configure middleware for JSON parsing, logging, and security
  - [ ] Set up comprehensive error handling middleware
  - [ ] Configure route organization and API versioning
  - [ ] Set up development server with hot reload capabilities
- [ ] Configure Supabase integration and CLI (AC: 2)
  - [ ] Install and configure Supabase CLI
  - [ ] Initialize Supabase project and establish connection
  - [ ] Set up environment variables for database connection
  - [ ] Configure Supabase client with proper authentication
  - [ ] Test database connectivity and basic queries
- [ ] Create database schema migration scripts (AC: 3)
  - [ ] Set up migration directory structure
  - [ ] Create initial schema migrations for all tables
  - [ ] Implement Row Level Security (RLS) policies
  - [ ] Create database indexes for performance optimization
  - [ ] Set up migration rollback procedures
- [ ] Plan and implement seed data (AC: 4)
  - [ ] Design seed data structure for development
  - [ ] Create user seed data with different roles (admin, supervisor, operator)
  - [ ] Create equipment hierarchy seed data
  - [ ] Create sample work orders and spare parts data
  - [ ] Implement seed data scripts for different environments
- [ ] Set up comprehensive API documentation (AC: 5)
  - [ ] Create OpenAPI 3.0 specification for all endpoints
  - [ ] Set up Swagger UI for interactive API documentation
  - [ ] Document authentication and authorization patterns
  - [ ] Create API usage examples and error response documentation
  - [ ] Set up automatic documentation generation from code
- [ ] Configure development environment and tooling (AC: 6)
  - [ ] Set up nodemon for development hot reload
  - [ ] Configure debugging with VS Code integration
  - [ ] Set up development database and environment variables
  - [ ] Create development scripts and npm tasks
- [ ] Establish security infrastructure (AC: 7)
  - [ ] Configure CORS policies for frontend integration
  - [ ] Set up authentication middleware for JWT validation
  - [ ] Implement rate limiting and request validation
  - [ ] Configure security headers and input sanitization
  - [ ] Set up request logging and audit trails

## Dev Notes

### Express.js Server Configuration
```typescript
// Key server configuration points
- Framework: Express.js 4.18+ with TypeScript 5.0+
- Middleware: helmet, cors, morgan, express.json()
- Error Handling: Centralized error handler with structured responses
- API Versioning: /api/v1/ prefix for all endpoints
- Development: nodemon for hot reload, ts-node for TypeScript execution
```

### Database Schema from Architecture
**Core Tables:**
- `users` - User accounts with role-based permissions
- `equipment` - Hierarchical equipment structure
- `work_orders` - Work order lifecycle management
- `work_order_audit` - Audit trail for state changes
- `spare_parts` - Inventory management
- `spare_part_usage` - Parts consumption tracking
- `equipment_spare_parts` - Equipment-parts associations

### Supabase Configuration
```bash
# Supabase CLI setup
supabase init
supabase login
supabase projects create
supabase db push  # Apply migrations
supabase db seed  # Load seed data
```

### Environment Variables
```bash
# Backend (.env)
SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
JWT_SECRET=your-jwt-secret
PORT=3001
NODE_ENV=development
DATABASE_URL=your-database-connection-string
```

### API Structure
```
src/
├── routes/                 # API route definitions
│   ├── auth.ts            # Authentication endpoints
│   ├── workOrders.ts      # Work order CRUD
│   ├── equipment.ts       # Equipment management
│   ├── spareParts.ts      # Inventory management
│   ├── users.ts           # User management
│   └── kpi.ts             # Analytics endpoints
├── services/              # Business logic
│   ├── authService.ts
│   ├── workOrderService.ts
│   ├── equipmentService.ts
│   └── sparePartService.ts
├── middleware/            # Express middleware
│   ├── auth.ts           # JWT verification
│   ├── validation.ts     # Input validation
│   ├── errorHandler.ts   # Error handling
│   └── rbac.ts           # Role-based access control
├── models/               # Data models
├── utils/               # Utilities
│   ├── database.ts      # Supabase client
│   ├── validators.ts    # Input validation schemas
│   └── logger.ts        # Logging configuration
└── server.ts            # Express server entry
```

### Security Configuration
```typescript
// Key security measures
- Authentication: Supabase Auth with JWT tokens
- Authorization: Row Level Security (RLS) policies
- Input Validation: Zod schemas for all endpoints
- CORS: Restrictive policies for frontend domains
- Rate Limiting: 100 requests per minute per user
- Security Headers: helmet middleware for security headers
```

### Migration Strategy
```sql
-- Migration files structure
supabase/migrations/
├── 20251107_create_users_table.sql
├── 20251107_create_equipment_table.sql
├── 20251107_create_work_orders_table.sql
├── 20251107_create_spare_parts_table.sql
└── 20251107_setup_rls_policies.sql
```

### Seed Data Structure
```typescript
// Seed data categories
- Users: 2 admins, 3 supervisors, 8 operators
- Equipment: 1 plant → 3 areas → 10 functional units → 50 equipment items
- Work Orders: Sample work orders in different statuses
- Spare Parts: 100 common maintenance parts with stock levels
```

### API Documentation Standards
- **OpenAPI 3.0:** Complete specification for all endpoints
- **Swagger UI:** Interactive documentation at /api/docs
- **Error Responses:** Standardized error format with codes
- **Authentication:** Bearer token authentication documented
- **Examples:** Request/response examples for all endpoints

### Development Scripts
```json
{
  "scripts": {
    "dev": "nodemon src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "vitest",
    "db:migrate": "supabase db push",
    "db:seed": "supabase db seed",
    "db:reset": "supabase db reset"
  }
}
```

### Error Handling Pattern
```typescript
interface ApiError {
  success: false;
  error: {
    code: string;
    message: string;
    details?: Record<string, any>;
    timestamp: string;
    requestId: string;
  };
}
```

### Testing
- **Framework:** Vitest for unit and integration tests
- **Test Location:** `src/__tests__/` directory
- **Test Standards:** >80% coverage for business logic
- **Integration Tests:** API endpoint testing with test database

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*